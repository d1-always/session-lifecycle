<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Lifecycle æµè§ˆå™¨ç¤ºä¾‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            transition: background-color 0.3s ease;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .active { background: #d4edda; color: #155724; }
        .inactive { background: #f8d7da; color: #721c24; }
        .paused { background: #fff3cd; color: #856404; }
        .log {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-start { background: #e8f5e8; }
        .log-end { background: #ffe8e8; }
        .log-life { background: #e8f4f8; }
        button {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Session Lifecycle æµè§ˆå™¨ç¤ºä¾‹</h1>
    
    <div id="status" class="status inactive">çŠ¶æ€: æœªåˆå§‹åŒ–</div>
    
    <div>
        <h3>æ“ä½œè¯´æ˜ï¼š</h3>
        <ul>
            <li>ğŸŸ¢ é¡µé¢åŠ è½½åè‡ªåŠ¨å¼€å§‹ä¼šè¯ï¼ˆinitç±»å‹ï¼‰</li>
            <li>â±ï¸ æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ï¼ˆsession_lifeäº‹ä»¶ï¼‰</li>
            <li>ğŸ”„ åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µä¼šæš‚åœä¼šè¯</li>
            <li>â†©ï¸ åˆ‡å›æ­¤æ ‡ç­¾é¡µä¼šæ¢å¤ä¼šè¯ï¼ˆactiveç±»å‹ï¼‰</li>
            <li>â° 2åˆ†é’Ÿå†…æ— æ´»åŠ¨ä¼šè‡ªåŠ¨ç»“æŸä¼šè¯</li>
            <li>ğŸ–±ï¸ ç‚¹å‡»ã€æ»šåŠ¨ã€ç§»åŠ¨é¼ æ ‡ä¼šé‡ç½®ä¸æ´»åŠ¨è®¡æ—¶å™¨</li>
        </ul>
    </div>

    <div>
        <button onclick="toggleDebug()">åˆ‡æ¢è°ƒè¯•æ¨¡å¼</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="manualActivity()">æ‰‹åŠ¨è§¦å‘æ´»åŠ¨</button>
    </div>

    <div id="log" class="log"></div>

    <!-- å¼•å…¥ session-lifecycle -->
    <script src="../dist/umd/session-lifecycle.min.js"></script>
    <script>
        let debugMode = false;
        let sessionInstance;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(status, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = 'çŠ¶æ€: ' + status + (type ? ' (' + type + ')' : '');
            statusElement.className = 'status ' + status.toLowerCase();
        }

        function toggleDebug() {
            debugMode = !debugMode;
            if (sessionInstance) {
                sessionInstance.destroy();
            }
            initializeSession();
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function manualActivity() {
            log('æ‰‹åŠ¨è§¦å‘ç”¨æˆ·æ´»åŠ¨', 'info');
            // æ´¾å‘ä¸€ä¸ªç‚¹å‡»äº‹ä»¶æ¥æ¨¡æ‹Ÿç”¨æˆ·æ´»åŠ¨
            document.dispatchEvent(new Event('click'));
        }

        function initializeSession() {
            // åˆ›å»ºä¼šè¯ç”Ÿå‘½å‘¨æœŸå®ä¾‹ï¼ˆå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼‰
            sessionInstance = SessionLifecycle.default({
                debug: debugMode,
                heartbeatInterval: 3000, // 30ç§’å¿ƒè·³
                inactivityTimeout: 10000  // 2åˆ†é’Ÿä¸æ´»åŠ¨è¶…æ—¶
            });
            
            const { on_session_start, on_session_end, on_session_life } = sessionInstance;
            
            // æ³¨å†Œä¼šè¯å¼€å§‹äº‹ä»¶
            on_session_start(function(data) {
                const typeText = data.type === 'init' ? 'åˆå§‹åŒ–' : 'é‡æ–°æ¿€æ´»';
                log(`ğŸš€ ä¼šè¯å¼€å§‹ï¼ç±»å‹: ${typeText}, æ—¶é—´æˆ³: ${data.timestamp}`, 'start');
                updateStatus('ACTIVE', data.type);
                document.body.style.backgroundColor = '#e8f5e8';
            });
            
            // æ³¨å†Œä¼šè¯ç»“æŸäº‹ä»¶
            on_session_end(function(data) {
                const sessionDuration = Math.round(data.duration / 1000);
                const totalDuration = Math.round(data.total_duration / 1000);
                log(`ğŸ”´ ä¼šè¯ç»“æŸï¼ä¼šè¯æ—¶é•¿: ${sessionDuration}ç§’, æ€»æ—¶é•¿: ${totalDuration}ç§’`, 'end');
                updateStatus('INACTIVE');
                document.body.style.backgroundColor = '#ffe8e8';
            });
            
            // æ³¨å†Œä¼šè¯ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¿ƒè·³ï¼‰
            on_session_life(function(data) {
                const intervalTime = Math.round(data.duration / 1000);
                const totalTime = Math.round(data.total_duration / 1000);
                log(`ğŸ’“ ä¼šè¯å¿ƒè·³ï¼å¿ƒè·³é—´éš”: ${intervalTime}ç§’, ä¼šè¯æ€»æ—¶é•¿: ${totalTime}ç§’`, 'life');
            });

            log('Session Lifecycle å·²åˆå§‹åŒ–' + (debugMode ? ' (è°ƒè¯•æ¨¡å¼)' : ''), 'info');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            initializeSession();
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ç”¨äºUIæ›´æ–°
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                updateStatus('PAUSED');
                document.body.style.backgroundColor = '#fff3cd';
            }
        });
    </script>
</body>
</html>
